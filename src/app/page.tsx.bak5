"use client";

import { useEffect, useState } from "react";
import { AttachmentIcon, ChevronDownIcon, RepeatIcon, TriangleUpIcon } from "@chakra-ui/icons";
import {
  Box,
  Container,
  VStack,
  Heading,
  Input,
  Select,
  Textarea,
  Button,
  Table,
  Thead,
  Tbody,
  Tr,
  Th,
  Td,
  useToast,
  FormControl,
  FormLabel,
  Text,
  HStack,
  Flex,
  Slider,
  SliderTrack,
  SliderFilledTrack,
  SliderThumb,
  Switch,
  Menu,
  MenuButton,
  MenuList,
  MenuItem,
} from "@chakra-ui/react";

type Provider = "openai" | "deepseek" | "openwebui";

interface APIConfig {
  provider: Provider;
  apiKey: string;
  baseUrl?: string;
}

interface SavedAPIConfig extends APIConfig {
  id: string;
  maskedKey: string;
}

interface Model {
  id: string;
  name: string;
  provider: Provider;
}

// Get default base URL for each provider
const getDefaultBaseUrl = (provider: Provider): string => {
  switch (provider) {
    case "openai":
      return "https://api.openai.com/v1";
    case "deepseek":
      return "https://api.deepseek.com/v1";
    case "openwebui":
      return "http://localhost:3001/v1";
  }
};

const NoFileSelected = () => (
  <Box 
    bg="purple.50" 
    p={4}
    py="45px"
    borderRadius="md" 
    borderWidth="1px" 
    borderColor="purple.200" 
    height="160px"
  >
    <VStack spacing={4} align="stretch" justify="center" height="full">
      <Box>
        <Text fontSize="sm" color="purple.600" mb={0.5}>File Status</Text>
        <Text fontSize="md" color="purple.900" fontWeight="medium">
          No file selected
        </Text>
      </Box>
      
      <Box>
        <Text fontSize="sm" color="purple.600" mb={0.5}>Question Count</Text>
        <Text fontSize="xl" color="purple.700" fontWeight="bold">
          -
        </Text>
        <Text fontSize="xs" color="gray.500" mt={0.5}>
          Upload a CSV file to see details
        </Text>
      </Box>
    </VStack>
  </Box>
);

interface EvaluationResult {
  questionId: string;
  modelResults: Record<string, boolean>;
}

type Provider = "openai" | "deepseek" | "openwebui";

interface APIConfig {
  provider: Provider;
  apiKey: string;
  baseUrl?: string;
}

interface SavedAPIConfig extends APIConfig {
  id: string;
  maskedKey: string;
}

interface Model {
  id: string;
  name: string;
  provider: Provider;
}

interface EvaluationResult {
  questionId: string;
  modelResults: Record<string, boolean>;
}

export default function Home() {
  const [selectedModels, setSelectedModels] = useState<Model[]>([]);
  const [availableModels, setAvailableModels] = useState<Model[]>([]);
  const [temperature, setTemperature] = useState(1.0);
  const [autoClearHistory, setAutoClearHistory] = useState(true);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [questionCount, setQuestionCount] = useState<number>(0);
  const [systemPrompt, setSystemPrompt] = useState("Answer the following multiple choice question by providing only the letter of the correct answer (e.g A, B, C, or D).");
  const [results, setResults] = useState<EvaluationResult[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isEvaluating, setIsEvaluating] = useState(false);
  const [progress, setProgress] = useState({ current: 0, total: 0 });
  const [modelSearch, setModelSearch] = useState("");
  const [currentProvider, setCurrentProvider] = useState<Provider>("openai");
  // Load saved API configurations from local storage
  const [savedApiConfigs, setSavedApiConfigs] = useState<SavedAPIConfig[]>(() => {
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem('apiConfigs');
      return saved ? JSON.parse(saved) : [];
    }
    return [];
  });
  
  const [newApiConfig, setNewApiConfig] = useState<APIConfig>({
    provider: "openai",
    apiKey: "",
    baseUrl: "",
  });
  const toast = useToast();

  const getApiConfig = (provider: Provider) => {
    return apiConfigs.find(config => config.provider === provider);
  };

  const getDefaultBaseUrl = (provider: Provider) => {
    switch (provider) {
      case "openai":
        return "https://api.openai.com/v1";
      case "deepseek":
        return "https://api.deepseek.com/v1";
      case "openwebui":
        return "http://localhost:3001/v1";
    }
  };

  const startEvaluation = async () => {
    if (!selectedFile || selectedModels.length === 0) {
      toast({
        title: "Evaluation requirements",
        description: "Please select both a CSV file and at least one model.",
        status: "warning",
        duration: 3000,
      });
      return;
    }

    setIsEvaluating(true);
    setProgress({ current: 0, total: questionCount });
    setResults([]);

    try {
      // Read the CSV file
      const reader = new FileReader();
      reader.onload = async (e) => {
        const content = e.target?.result as string;
        const lines = content.split('\\n').filter(line => line.trim());
        const questions = lines.slice(1); // Skip header row
        
        const evaluationResults: EvaluationResult[] = [];
        
        // Process each question
        for (let i = 0; i < questions.length; i++) {
          const [id, question, correctAnswer] = questions[i].split(',').map(s => s.trim());
          const modelResults: Record<string, boolean> = {};
          
          // Query each model
          for (const model of selectedModels) {
            try {
              const baseUrl = apiConfigs[model.provider].baseUrl || getDefaultBaseUrl();
              const response = await fetch(`${baseUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${apiConfigs[model.provider].key}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  model: model.id,
                  messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: question }
                  ],
                  temperature: temperature
                })
              });

              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              
              const data = await response.json();
              const answer = data.choices[0].message.content.trim().toUpperCase();
              modelResults[model.id] = answer === correctAnswer.toUpperCase();

              if (autoClearHistory) {
                // Clear context for next question
                await new Promise(resolve => setTimeout(resolve, 500));
              }
            } catch (error) {
              console.error(`Error with model ${model.name}:`, error);
              modelResults[model.id] = false;
            }
          }
          
          evaluationResults.push({
            questionId: id,
            modelResults
          });

          setProgress(prev => ({ ...prev, current: i + 1 }));
          setResults([...evaluationResults]);
        }

        // Scroll to results section
        document.getElementById('evaluation')?.scrollIntoView({ behavior: 'smooth' });
        
        toast({
          title: "Evaluation completed",
          description: `Processed ${questions.length} questions with ${selectedModels.length} models`,
          status: "success",
          duration: 5000,
        });
      };
      
      reader.readAsText(selectedFile);
    } catch (error) {
      console.error('Evaluation error:', error);
      toast({
        title: "Evaluation failed",
        description: "There was an error during evaluation. Please check the console for details.",
        status: "error",
        duration: 5000,
      });
    } finally {
      setIsEvaluating(false);
    }
  };

  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    setSelectedFile(file);
    const reader = new FileReader();
    
    reader.onload = (e) => {
      const content = e.target?.result as string;
      const lineCount = content.split('\n')
        .filter(line => line.trim().length > 0)
        .length - 1; // Subtract header row
      setQuestionCount(lineCount);
    };
    
    reader.readAsText(file);
  };

    const verifyApiKey = async () => {
    const config = getApiConfig(currentProvider);
    if (!config) {
      toast({
        title: "No API Configuration",
        description: "Please add an API configuration first",
        status: "warning",
        duration: 3000,
      });
      return;
    }

    setIsLoading(true);
    const baseUrl = config.baseUrl || getDefaultBaseUrl(currentProvider);

    try {
      const response = await fetch(`${baseUrl}/models`, {
        headers: {
          Authorization: `Bearer ${config.apiKey}`,
        },
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      const models = data.data.map((model: any) => ({
        id: model.id,
        name: model.id,
        provider: currentProvider,
      }));

      setAvailableModels(prev => {
        const filteredPrev = prev.filter(m => m.provider !== currentProvider);
        return [...filteredPrev, ...models];
      });

      toast({
        title: `${currentProvider} API key verified`,
        description: `${models.length} models available`,
        status: "success",
        duration: 3000,
        isClosable: true,
      });
    } catch (error) {
      console.error(`Error verifying ${currentProvider} API key:`, error);
      toast({
        title: `Error verifying ${currentProvider} API key`,
        description: "Please check your API key and try again",
        status: "error",
        duration: 3000,
        isClosable: true,
      });
    } finally {
      setIsLoading(false);
    }
  };

  const [apiConfigs, setApiConfigs] = useState<SavedAPIConfig[]>(() => {
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem('apiConfigs');
      return saved ? JSON.parse(saved) : [];
    }
    return [];
  });

  const [newApiConfig, setNewApiConfig] = useState<APIConfig>({
    provider: "openai",
    apiKey: "",
    baseUrl: "",
  });

  const handleSaveApiConfig = () => {
    if (!newApiConfig.apiKey) {
      toast({
        title: "API Key Required",
        description: "Please enter an API key",
        status: "error",
        duration: 3000,
        isClosable: true,
      });
      return;
    }

    const id = Math.random().toString(36).substr(2, 9);
    const maskedKey = newApiConfig.apiKey.slice(0, 4) + "..." + newApiConfig.apiKey.slice(-4);
    
    const newConfig: SavedAPIConfig = {
      ...newApiConfig,
      id,
      maskedKey,
    };

    const updatedConfigs = [...apiConfigs, newConfig];
    setApiConfigs(updatedConfigs);
    localStorage.setItem('apiConfigs', JSON.stringify(updatedConfigs));

    setNewApiConfig({
      provider: "openai",
      apiKey: "",
      baseUrl: "",
    });

    toast({
      title: "API Configuration Saved",
      description: `Added new ${newConfig.provider} configuration`,
      status: "success",
      duration: 3000,
      isClosable: true,
    });
  };

  const menuItems = [
    { id: "models", title: "1. Select Models", icon: "ü§ñ" },
    { id: "database", title: "2. MCQ Database", icon: "üìù" },
    { id: "config", title: "3. Configuration", icon: "‚öôÔ∏è" },
    { id: "evaluation", title: "4. Evaluation", icon: "üìä" }
  ];

  return (
    <Flex h="100vh">
      {/* Sidebar */}
      <Box
        w="280px"
        bg="purple.50"
        p={6}
        borderRight="1px"
        borderColor="purple.100"
        position="fixed"
        h="100vh"
        left={0}
        top={0}
      >
        <VStack spacing={6} align="stretch">
          <Box mb={6}>
            <Heading size="md" color="purple.700" mb={1}>LLM Evaluation</Heading>
            <Text fontSize="sm" color="purple.600">Accuracy vs Consistency</Text>
          </Box>

          <VStack spacing={6} align="stretch">
            <Box>
              <VStack spacing={2} align="stretch">
                {menuItems.map((item) => (
                  <Button
                    key={item.id}
                    variant="ghost"
                    justifyContent="flex-start"
                    py={3}
                    pl={4}
                    leftIcon={
                      <Box p={1} bg="purple.100" borderRadius="md">
                        <Text fontSize="sm">{item.icon}</Text>
                      </Box>
                    }
                    onClick={() => {
                      const element = document.getElementById(item.id);
                      if (element) {
                        element.scrollIntoView({ behavior: "smooth" });
                      }
                    }}
                  >
                    {item.title}
                  </Button>
                ))}
              </VStack>
            </Box>

            {/* API Configuration Section */}
            <Box mt="auto" pt={6} borderTop="1px" borderColor="purple.100">
              <VStack spacing={4} align="stretch">
                <Heading size="sm" color="purple.700">Add API Configuration</Heading>
                
                <FormControl>
                  <FormLabel>Provider</FormLabel>
                  <Select
                    value={newApiConfig.provider}
                    onChange={(e) => setNewApiConfig({
                      ...newApiConfig,
                      provider: e.target.value as Provider
                    })}
                  >
                    <option value="openai">OpenAI</option>
                    <option value="deepseek">DeepSeek</option>
                    <option value="openwebui">OpenWebUI</option>
                  </Select>
                </FormControl>

                <FormControl>
                  <FormLabel>API Key</FormLabel>
                  <Input
                    type="password"
                    value={newApiConfig.apiKey}
                    onChange={(e) => setNewApiConfig({
                      ...newApiConfig,
                      apiKey: e.target.value
                    })}
                    placeholder="Enter API key"
                  />
                </FormControl>

                <FormControl>
                  <FormLabel>Base URL (Optional)</FormLabel>
                  <Input
                    value={newApiConfig.baseUrl}
                    onChange={(e) => setNewApiConfig({
                      ...newApiConfig,
                      baseUrl: e.target.value
                    })}
                    placeholder={getDefaultBaseUrl(newApiConfig.provider)}
                  />
                </FormControl>

                <Button
                  colorScheme="purple"
                  onClick={handleSaveApiConfig}
                >
                  Add API Configuration
                </Button>

                {savedApiConfigs.length > 0 && (
                  <VStack spacing={2} align="stretch" mt={4}>
                    <Text fontWeight="bold" color="purple.700">Saved Configurations</Text>
                    {savedApiConfigs.map((config) => (
                      <Box
                        key={config.id}
                        p={2}
                        bg="purple.100"
                        borderRadius="md"
                        fontSize="sm"
                      >
                        <Text fontWeight="bold">{config.provider}</Text>
                        <Text>API Key: {config.maskedKey}</Text>
                        {config.baseUrl && <Text>URL: {config.baseUrl}</Text>}
                      </Box>
                    ))}
                  </VStack>
                )}
              </VStack>
            </Box>
          </VStack>
                  if (element) {
                    element.scrollIntoView({ behavior: "smooth" });
                  }
                }}
              >
                {item.title}
              </Button>
            ))}
          </VStack>

          <Box mt="auto" pt={6} borderTop="1px" borderColor="purple.100">
            <VStack spacing={4} align="stretch">
              <Heading size="sm" color="purple.700">Add API Configuration</Heading>
              
              <FormControl>
                <FormLabel>Provider</FormLabel>
                <Select
                  value={newApiConfig.provider}
                  onChange={(e) => setNewApiConfig({
                    ...newApiConfig,
                    provider: e.target.value as Provider
                  })}
                >
                  <option value="openai">OpenAI</option>
                  <option value="deepseek">DeepSeek</option>
                  <option value="openwebui">OpenWebUI</option>
                </Select>
              </FormControl>

              <FormControl>
                <FormLabel>API Key</FormLabel>
                <Input
                  type="password"
                  value={newApiConfig.apiKey}
                  onChange={(e) => setNewApiConfig({
                    ...newApiConfig,
                    apiKey: e.target.value
                  })}
                  placeholder="Enter API key"
                />
              </FormControl>

              <FormControl>
                <FormLabel>Base URL (Optional)</FormLabel>
                <Input
                  value={newApiConfig.baseUrl}
                  onChange={(e) => setNewApiConfig({
                    ...newApiConfig,
                    baseUrl: e.target.value
                  })}
                  placeholder="Enter base URL"
                />
              </FormControl>

              <Button
                colorScheme="purple"
                onClick={handleSaveApiConfig}
              >
                Add API Configuration
              </Button>

              {apiConfigs.length > 0 && (
                <VStack spacing={2} align="stretch" mt={4}>
                  <Text fontWeight="bold" color="purple.700">Saved Configurations</Text>
                  {apiConfigs.map((config) => (
                    <Box
                      key={config.id}
                      p={2}
                      bg="purple.100"
                      borderRadius="md"
                      fontSize="sm"
                    >
                      <Text fontWeight="bold">{config.provider}</Text>
                      <Text>API Key: {config.maskedKey}</Text>
                    </Box>
                  ))}
                </VStack>
              )}
            </VStack>
          </Box>
                  element?.scrollIntoView({ behavior: "smooth" });
                }}
                _hover={{ bg: "purple.100" }}
                color="purple.700"
                fontSize="sm"
                fontWeight="medium"
              >
                {item.title}
              </Button>
            ))}
          </VStack>
        </VStack>
      </Box>

      {/* Main Content */}
      <Box ml="280px" flex={1} py={8}>
        <Box maxW="1200px" mx="auto" px={8}>
          <VStack spacing={6} align="stretch">

        <Box 
          id="models"
          p={6} 
          borderRadius="lg" 
          bg="white" 
          boxShadow="lg" 
          border="1px" 
          borderColor="purple.100"
          scroll-margin-top="2rem"
        >
          <HStack spacing={2} mb={4}>
            <Box p={1.5} bg="purple.100" borderRadius="md">
              <Text fontSize="sm" color="purple.600">ü§ñ</Text>
            </Box>
            <Heading size="sm">Add Large Language Models (LLMs)</Heading>
          </HStack>

          <Box>
            <VStack spacing={4} align="stretch">
              <HStack spacing={3} align="flex-end">
                <FormControl flex="1">
                  <FormLabel fontSize="sm">API Provider</FormLabel>
                  <Select 
                    value={currentProvider} 
                    onChange={(e) => setCurrentProvider(e.target.value as "openai" | "deepseek" | "openwebui")}
                    bg="gray.50"
                    size="sm"
                  >
                    <option value="openai">OpenAI API</option>
                    <option value="deepseek">DeepSeek API</option>
                    <option value="openwebui">Open WebUI</option>
                  </Select>
                </FormControl>

                <FormControl flex="2">
                  <FormLabel fontSize="sm">API Key</FormLabel>
                  <Input
                    type="password"
                    value={getApiKey()}
                    onChange={(e) => updateApiKey(e.target.value)}
                    placeholder="Enter your API key"
                    bg="gray.50"
                    size="sm"
                  />
                </FormControl>

                <FormControl flex="2">
                  <FormLabel fontSize="sm">Base URL (Optional)</FormLabel>
                  <Input
                    value={getBaseUrl()}
                    onChange={(e) => updateBaseUrl(e.target.value)}
                    placeholder={getDefaultBaseUrl()}
                    bg="gray.50"
                    size="sm"
                  />
                </FormControl>
              </HStack>

              <FormControl>
                <FormLabel fontSize="sm">Add Model</FormLabel>
                <HStack spacing={3} align="flex-end">
                  <Box position="relative" flex="1">
                    <Menu matchWidth>
                      <MenuButton
                        as={Button}
                        rightIcon={<ChevronDownIcon />}
                        width="full"
                        bg="gray.50"
                        size="sm"
                        textAlign="left"
                        fontWeight="normal"
                      >
                        Select model
                      </MenuButton>
                      <MenuList bg="gray.50" p={0}>
                        {availableModels.filter(model => !selectedModels.some(m => m.id === model.id)).length > 8 && (
                          <Box 
                            borderBottom="1px" 
                            borderColor="gray.200"
                            position="sticky"
                            top={0}
                            bg="gray.50"
                            zIndex={1}
                          >
                            <Input
                              placeholder="Search models..."
                              size="sm"
                              value={modelSearch}
                              onChange={(e) => setModelSearch(e.target.value)}
                              bg="white"
                              border="none"
                              borderRadius="0"
                              _focus={{
                                boxShadow: "none",
                                bg: "white"
                              }}
                            />
                          </Box>
                        )}
                        <Box maxH="250px" overflowY="auto">
                          {availableModels
                            .filter(model => 
                              !selectedModels.some(m => m.id === model.id) &&
                              (model.name.toLowerCase().includes(modelSearch.toLowerCase()) ||
                               model.id.toLowerCase().includes(modelSearch.toLowerCase()))
                            )
                            .map(model => (
                              <MenuItem
                                key={model.id}
                                onClick={() => {
                                  setSelectedModels(prev => [...prev, model]);
                                  setModelSearch("");
                                }}
                                py={2}
                                bg="gray.50"
                                _hover={{ bg: "gray.100" }}
                              >
                                {model.name}
                              </MenuItem>
                            ))
                          }
                        </Box>
                      </MenuList>
                    </Menu>
                  </Box>
                  <Button
                    colorScheme="purple"
                    onClick={verifyApiKey}
                    isLoading={isLoading}
                    size="sm"
                    leftIcon={<RepeatIcon />}
                  >
                    Load Models
                  </Button>
                </HStack>
              </FormControl>

              {selectedModels.length > 0 && (
                <Box mt={3}>
                  <Text fontWeight="medium" fontSize="sm" mb={1.5}>Selected Models:</Text>
                  <Flex wrap="wrap" gap={2}>
                    {selectedModels.map((model, index) => (
                      <Box
                        key={model.id}
                        bg="purple.50"
                        border="1px"
                        borderColor="purple.200"
                        borderRadius="md"
                        px={3}
                        py={1.5}
                      >
                        <HStack spacing={2} align="center">
                          <Text fontSize="xs" color="purple.700">
                            <Text as="span" color="purple.500" mr={1}>{index + 1}.</Text>
                            <Text as="span" color="purple.500">{model.provider}/</Text>
                            {model.name}
                          </Text>
                          <Button
                            size="xs"
                            variant="ghost"
                            colorScheme="purple"
                            onClick={() => setSelectedModels(prev => prev.filter(m => m.id !== model.id))}
                            p={1}
                            height="auto"
                            minW="auto"
                            _hover={{ opacity: 0.8 }}
                          >
                            ‚úï
                          </Button>
                        </HStack>
                      </Box>
                    ))}
                  </Flex>
                </Box>
              )}
            </VStack>
          </Box>
        </Box>

        <Box 
          id="database"
          p={6} 
          borderRadius="lg" 
          bg="white" 
          boxShadow="lg" 
          border="1px" 
          borderColor="purple.100"
          scroll-margin-top="2rem"
        >
          <HStack spacing={8} align="flex-start">
            {/* Left Column */}
            <VStack spacing={4} align="stretch" flex="1">
              <HStack spacing={2}>
                <Box p={1.5} bg="purple.100" borderRadius="md">
                  <Text fontSize="sm" color="purple.600">üìù</Text>
                </Box>
                <Heading size="sm">MCQ Database</Heading>
              </HStack>

              <Box>
                <Text fontSize="md" color="gray.700" fontWeight="medium" mb={1}>
                  Question Database File
                </Text>
                <Text fontSize="sm" color="gray.500">
                  Upload a CSV file with columns: ID, Question, Correct Answer
                </Text>
              </Box>

              <Button
                leftIcon={<AttachmentIcon />}
                colorScheme="purple"
                variant="solid"
                onClick={() => document.getElementById('file-upload')?.click()}
                width="full"
                size="sm"
              >
                Upload CSV File
              </Button>

              <Input
                id="file-upload"
                type="file"
                accept=".csv"
                onChange={handleFileUpload}
                display="none"
              />
            </VStack>

            {/* Right Column */}
            <VStack spacing={3} align="stretch" flex="1" mt={1}>
              {selectedFile ? (
                <Box bg="purple.50" p={4} borderRadius="md" borderWidth="1px" borderColor="purple.200">
                  <VStack align="stretch" spacing={2}>
                    <Box>
                      <Text fontSize="sm" color="purple.600" mb={0.5}>Current File</Text>
                      <Text fontSize="md" color="purple.900" fontWeight="medium">
                        {selectedFile.name}
                      </Text>
                    </Box>
                    
                    <Box>
                      <Text fontSize="sm" color="purple.600" mb={0.5}>Question Count</Text>
                      <Text fontSize="xl" color="purple.700" fontWeight="bold" display="inline">
                        {questionCount > 0 ? `${questionCount.toLocaleString()} ` : '...'}
                        <Text as="span" fontSize="xs" color="gray.500">
                          {questionCount > 0 ? 'questions loaded' : 'Processing file...'}
                        </Text>
                      </Text>
                    </Box>
                  </VStack>
                </Box>
              ) : (
                <Box bg="gray.50" p={6} borderRadius="lg" textAlign="center" padding={45}>
                  <Text fontSize="md" color="gray.500">
                    No file selected
                  </Text>
                  <Text fontSize="sm" color="gray.400" mt={1}>
                    Upload a CSV file to see details
                  </Text>
                </Box>
              )}
            </VStack>
          </HStack>
        </Box>

        <Box 
          id="config"
          p={6} 
          borderRadius="lg" 
          bg="white" 
          boxShadow="lg" 
          border="1px" 
          borderColor="purple.100"
          scroll-margin-top="2rem"
        >
          <HStack spacing={2} mb={4}>
            <Box p={1.5} bg="purple.100" borderRadius="md">
              <Text fontSize="sm" color="purple.600">‚öôÔ∏è</Text>
            </Box>
            <Heading size="sm">LLMs Configuration</Heading>
          </HStack>

          <VStack spacing={4} align="stretch">
            <HStack spacing={8} align="flex-start">
              <FormControl flex="3">
                <FormLabel fontSize="sm">System Prompt</FormLabel>
                <Textarea
                  value={systemPrompt}
                  onChange={(e) => setSystemPrompt(e.target.value)}
                  placeholder="Enter system prompt for the AI model"
                  rows={5}
                  bg="gray.50"
                  size="sm"
                />
              </FormControl>

              <VStack spacing={6} align="stretch" flex="2">
                <FormControl>
                  <FormLabel fontSize="sm">Temperature: {temperature}</FormLabel>
                  <Slider
                    value={temperature}
                    onChange={setTemperature}
                    min={0}
                    max={2}
                    step={0.1}
                    colorScheme="purple"
                    size="sm"
                  >
                    <SliderTrack>
                      <SliderFilledTrack />
                    </SliderTrack>
                    <SliderThumb />
                  </Slider>
                  <Text fontSize="xs" color="gray.500" mt={1}>
                    Lower values make the output more focused and deterministic
                  </Text>
                </FormControl>

                <FormControl>
                  <HStack justify="space-between" align="center" spacing={4}>
                    <Box flex="1">
                      <FormLabel fontSize="sm" mb={0} cursor="pointer">
                        Auto Clear History
                      </FormLabel>
                      <Text fontSize="xs" color="gray.500">
                        Clear temporary history between questions
                      </Text>
                    </Box>
                    <Switch
                      isChecked={autoClearHistory}
                      onChange={() => setAutoClearHistory(!autoClearHistory)}
                      colorScheme="purple"
                      size="md"
                    />
                  </HStack>
                </FormControl>
              </VStack>
            </HStack>

            <VStack spacing={4} align="flex-start">
              <Button
                colorScheme="purple"
                width="200px"
                isDisabled={selectedModels.length === 0 || !selectedFile || isEvaluating}
                size="md"
                leftIcon={<TriangleUpIcon transform="rotate(90deg)" boxSize={3} />}
                onClick={startEvaluation}
                isLoading={isEvaluating}
                loadingText={`Processing ${progress.current}/${progress.total}`}
              >
                Start Evaluation
              </Button>
              {isEvaluating && (
                <Box w="200px">
                  <Text fontSize="sm" color="purple.600" mb={1}>
                    Progress: {Math.round((progress.current / progress.total) * 100)}%
                  </Text>
                  <Box w="full" h="2px" bg="purple.100" borderRadius="full" overflow="hidden">
                    <Box
                      w={`${(progress.current / progress.total) * 100}%`}
                      h="full"
                      bg="purple.500"
                      transition="width 0.3s ease-in-out"
                    />
                  </Box>
                </Box>
              )}
            </VStack>
          </VStack>
        </Box>

        <Box 
          id="evaluation"
          p={6} 
          borderRadius="lg" 
          bg="white" 
          boxShadow="lg" 
          border="1px" 
          borderColor="purple.100"
          scroll-margin-top="2rem"
        >
          <HStack spacing={2} mb={6}>
            <Box p={1.5} bg="purple.100" borderRadius="md">
              <Text fontSize="sm" color="purple.600">üìä</Text>
            </Box>
            <Heading size="sm">Evaluation Results</Heading>
          </HStack>

          {results.length === 0 ? (
            <Box 
              bg="purple.50" 
              p={8} 
              borderRadius="md" 
              borderWidth="1px" 
              borderColor="purple.200"
              textAlign="center"
            >
              <VStack spacing={4}>
                <Box
                  w="48px"
                  h="48px"
                  bg="purple.100"
                  borderRadius="full"
                  display="flex"
                  alignItems="center"
                  justifyContent="center"
                  mx="auto"
                  mb={2}
                >
                  <Text fontSize="24px">üìà</Text>
                </Box>
                <VStack spacing={1}>
                  <Text fontSize="lg" fontWeight="medium" color="purple.700">
                    No evaluation results yet
                  </Text>
                  <Text fontSize="sm" color="purple.600">
                    Results will appear here once you start the evaluation
                  </Text>
                </VStack>
              </VStack>
            </Box>
          ) : (
            <Box>
              {/* Results content will go here */}
            </Box>
          )}
        </Box>

        {results.length > 0 && (
          <Box 
            p={6} 
            borderRadius="xl" 
            bg="white" 
            boxShadow="sm"
            scroll-margin-top="2rem"
          >
            <HStack spacing={3} mb={6}>
              <Box p={2} bg="purple.100" borderRadius="md">
                <Text color="purple.600">üìä</Text>
              </Box>
              <Heading size="md">Results</Heading>
            </HStack>

            <Table variant="simple">
              <Thead>
                <Tr>
                  <Th>Question</Th>
                  {selectedModels.map((model) => (
                    <Th key={model.id}>{model.name}</Th>
                  ))}
                </Tr>
              </Thead>
              <Tbody>
                {results.map((result) => (
                  <Tr key={result.questionId}>
                    <Td>{result.questionId}</Td>
                    {selectedModels.map((model) => (
                      <Td key={model.id}>
                        {result.modelResults[model.id] ? "‚úÖ" : "‚ùå"}
                      </Td>
                    ))}
                  </Tr>
                ))}
              </Tbody>
            </Table>
          </Box>
        )}
          </VStack>
        </Box>
      </Box>
    </Flex>
  );
}